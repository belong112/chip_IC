<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>晶圓製程實驗室 (Wafer Lab)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom Styles -->
    <style>
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        
        @keyframes moveLeftRight {
            0% { transform: translateX(-40px) translateZ(0); }
            100% { transform: translateX(40px) translateZ(0); }
        }
        .animate-move-horizontal { animation: moveLeftRight 1s infinite alternate ease-in-out; }
        
        @keyframes dopingRain {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(300px); opacity: 0; }
        }
        
        @keyframes flash {
            0%, 100% { opacity: 0; }
            50% { opacity: 0.8; }
        }
        .animate-flash { animation: flash 1.5s infinite; }
        
        @keyframes fade-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }

        @keyframes slide-up {
            from { transform: scaleY(0); }
            to { transform: scaleY(1); }
        }
        .animate-slide-up { animation: slide-up 0.5s ease-out forwards; }
        
        @keyframes fade-in-down {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down { animation: fade-in-down 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icon Components (Inline SVGs) ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg>
        );

        const ChevronRight = (props) => <IconBase {...props}><polyline points="9 18 15 12 9 6" /></IconBase>;
        const ChevronLeft = (props) => <IconBase {...props}><polyline points="15 18 9 12 15 6" /></IconBase>;
        const RefreshCcw = (props) => <IconBase {...props}><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" /><path d="M16 16h5v5" /></IconBase>;
        const Zap = (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></IconBase>;
        const Layers = (props) => <IconBase {...props}><polygon points="12 2 2 7 12 12 22 7 12 2" /><polyline points="2 17 12 22 22 17" /><polyline points="2 12 12 17 22 12" /></IconBase>;
        const Sun = (props) => <IconBase {...props}><circle cx="12" cy="12" r="4" /><path d="M12 2v2" /><path d="M12 20v2" /><path d="m4.93 4.93 1.41 1.41" /><path d="m17.66 17.66 1.41 1.41" /><path d="M2 12h2" /><path d="M20 12h2" /><path d="m6.34 17.66-1.41 1.41" /><path d="m19.07 4.93-1.41 1.41" /></IconBase>;
        const Eraser = (props) => <IconBase {...props}><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21" /><path d="M22 21H7" /><path d="m5 11 9 9" /></IconBase>;
        const Activity = (props) => <IconBase {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2" /></IconBase>;
        const ArrowDown = (props) => <IconBase {...props}><line x1="12" y1="5" x2="12" y2="19" /><polyline points="19 12 12 19 5 12" /></IconBase>;
        const BoxIcon = (props) => <IconBase {...props}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /><polyline points="3.27 6.96 12 12.01 20.73 6.96" /><line x1="12" y1="22.08" x2="12" y2="12" /></IconBase>;
        const Disc = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10" /><circle cx="12" cy="12" r="3" /></IconBase>;
        const Monitor = (props) => <IconBase {...props}><rect width="20" height="14" x="2" y="3" rx="2" /><line x1="8" x2="16" y1="21" y2="21" /><line x1="12" x2="12" y1="17" y2="21" /></IconBase>;
        const Sparkles = (props) => <IconBase {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z" /></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></IconBase>;
        const MessageSquare = (props) => <IconBase {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" /></IconBase>;
        const HelpCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10" /><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" /><path d="M12 17h.01" /></IconBase>;
        const Loader2 = (props) => <IconBase {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56" /></IconBase>;

        // --- Data Definitions ---
        const PROCESS_STEPS = [
          {
            id: 'init',
            title: '1. 初始矽晶圓 (Silicon Wafer)',
            description: '這是半導體的基底，通常由高純度的矽(Si)製成。就像蓋房子需要地基，晶片也需要一個完美的基底。',
            icon: <Layers size={24} />,
            color: 'bg-gray-300',
            instruction: '準備一片乾淨的矽晶圓。'
          },
          {
            id: 'deposition',
            title: '2. 薄膜沈積 (Deposition)',
            description: '在晶圓表面生長一層二氧化矽(SiO2)或其他絕緣材料。這層薄膜將作為保護層或絕緣層。',
            icon: <ArrowDown size={24} />,
            color: 'bg-blue-200',
            instruction: '沈積氧化層。'
          },
          {
            id: 'coating',
            title: '3. 塗佈光阻 (Photoresist Coating)',
            description: '在薄膜上均勻塗上一層感光液體，稱為「光阻」。光阻對特定波長的光線敏感，是圖形轉移的關鍵。',
            icon: <Layers size={24} className="text-purple-500" />,
            color: 'bg-purple-400',
            instruction: '旋轉塗佈光阻。'
          },
          {
            id: 'lithography',
            title: '4. 微影曝光 (Photolithography)',
            description: '使用光罩(Mask)遮擋光線，用強紫外光照射。被光照到的光阻化學性質會改變（此處模擬正光阻，曝光部分變軟）。',
            icon: <Sun size={24} className="text-yellow-500" />,
            color: 'bg-yellow-200',
            instruction: '通過光罩進行曝光。'
          },
          {
            id: 'etching',
            title: '5. 顯影與蝕刻 (Etching)',
            description: '先洗掉被曝光的光阻（顯影），露出下方的氧化層。接著用化學藥劑或電漿「吃掉」露出的氧化層，將圖案轉移到氧化層上。',
            icon: <Eraser size={24} />,
            color: 'bg-red-200',
            instruction: '移除曝光區域並蝕刻氧化層。'
          },
          {
            id: 'stripping',
            title: '6. 去除光阻 (Stripping)',
            description: '蝕刻完成後，剩下的光阻已經完成了保護任務，需要被徹底清除，只留下有圖案的氧化層。',
            icon: <RefreshCcw size={24} />,
            color: 'bg-gray-200',
            instruction: '清除剩餘的光阻劑。'
          },
          {
            id: 'doping',
            title: '7. 離子佈植 (Doping)',
            description: '利用高能量將雜質離子（如硼或磷）打入矽晶圓裸露的區域，改變其導電性質，形成電晶體的「源極」或「汲極」。',
            icon: <Zap size={24} className="text-green-600" />,
            color: 'bg-green-200',
            instruction: '注入離子改變導電性。'
          },
          {
            id: 'metal_dep',
            title: '8. 金屬沈積 (Metal Deposition)',
            description: '沈積導電金屬（如鎢、銅或鋁），填滿蝕刻出的孔洞並覆蓋整個表面，建立與下方矽基板的電路連接。',
            icon: <BoxIcon size={24} className="text-slate-600" />,
            color: 'bg-slate-300',
            instruction: '沈積金屬層以填補孔洞。'
          },
          {
            id: 'cmp',
            title: '9. 化學機械研磨 (CMP)',
            description: '利用化學漿料與機械研磨墊，像磨砂紙一樣將表面多餘的金屬磨平，只保留孔洞中的金屬導線，確保表面極度平坦。',
            icon: <Disc size={24} className="text-cyan-600" />,
            color: 'bg-cyan-200',
            instruction: '研磨表面移除多餘金屬。'
          }
        ];

        // --- Components ---
        const Cuboid = ({ 
            width = '100%', 
            height = '100%', 
            depth = '100px', 
            colorClass = 'bg-gray-500', 
            topColorClass,
            sideColorClass,
            className = '',
            style = {},
            is3D = false,
            children 
        }) => {
            const sideColor = sideColorClass || colorClass.replace('bg-', 'bg-').replace('200', '300').replace('300', '400').replace('400', '500').replace('500', '600');
            const topColor = topColorClass || colorClass.replace('bg-', 'bg-').replace('600', '500').replace('500', '400').replace('400', '300').replace('300', '200');

            if (style.height === '0px' || style.height === 0) return null;

            return (
            <div className={`relative transform-style-3d ${className}`} style={{ width, height, ...style }}>
                {/* Front Face */}
                <div className={`absolute inset-0 ${colorClass} flex items-center justify-center overflow-hidden backface-hidden z-10 border-x border-t border-black/10`}>
                {children}
                </div>
                
                {/* Back Face */}
                {is3D && (
                <div 
                    className={`absolute inset-0 ${sideColor} backface-hidden`}
                    style={{ transform: `translateZ(-${depth}) rotateY(180deg)` }}
                />
                )}

                {/* Right Face */}
                {is3D && (
                <div 
                    className={`absolute top-0 right-0 h-full ${sideColor} origin-right backface-hidden border-t border-black/10`}
                    style={{ width: depth, transform: 'rotateY(90deg)' }}
                />
                )}

                {/* Left Face */}
                {is3D && (
                <div 
                    className={`absolute top-0 left-0 h-full ${sideColor} origin-left backface-hidden border-t border-black/10`}
                    style={{ width: depth, transform: 'rotateY(-90deg)' }}
                />
                )}

                {/* Top Face */}
                {is3D && (
                <div 
                    className={`absolute top-0 left-0 w-full ${topColor} origin-top backface-hidden border-x border-black/10`}
                    style={{ height: depth, transform: 'rotateX(90deg)' }}
                />
                )}
            </div>
            );
        };

        const SemiconductorFab = () => {
            const [currentStep, setCurrentStep] = useState(0);
            const [isAnimating, setIsAnimating] = useState(false);
            const [is3D, setIs3D] = useState(false);
            
            // AI State
            const [showAiModal, setShowAiModal] = useState(false);
            const [aiContent, setAiContent] = useState("");
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [aiTitle, setAiTitle] = useState("");
            const [userApiKey, setUserApiKey] = useState(""); // User input for API Key

            const [animState, setAnimState] = useState({
                hasOxide: false,
                hasResist: false,
                isExposed: false,
                isEtched: false,
                resistRemoved: false,
                isDoped: false,
                hasMetal: false,
                isPolished: false
            });

            useEffect(() => {
                const isCmpStep = PROCESS_STEPS[currentStep].id === 'cmp';

                const newAnimState = {
                hasOxide: currentStep >= 1,
                hasResist: currentStep >= 2 && currentStep < 5,
                isExposed: currentStep >= 3 && currentStep < 5,
                isEtched: currentStep >= 4,
                resistRemoved: currentStep >= 5,
                isDoped: currentStep >= 6,
                hasMetal: currentStep >= 7,
                isPolished: currentStep > 8 
                };
                setAnimState(newAnimState);
                
                setIsAnimating(true);

                let timers = [];

                if (isCmpStep) {
                timers.push(setTimeout(() => {
                    setAnimState(prev => ({ ...prev, isPolished: true }));
                }, 500));
                timers.push(setTimeout(() => {
                    setIsAnimating(false);
                }, 4000));
                } else {
                timers.push(setTimeout(() => setIsAnimating(false), 1000));
                }
                
                return () => timers.forEach(clearTimeout);
            }, [currentStep]);

            const nextStep = () => {
                if (currentStep < PROCESS_STEPS.length - 1) {
                setCurrentStep(prev => prev + 1);
                }
            };

            const prevStep = () => {
                if (currentStep > 0) {
                setCurrentStep(prev => prev - 1);
                }
            };

            const reset = () => {
                setCurrentStep(0);
            };

            // Gemini API Call
            const callGemini = async (type) => {
                // Check if API Key is present
                if (!userApiKey) {
                    setAiTitle("請輸入 API Key");
                    setAiContent("請在右側或下方的設定欄位中輸入您的 Google Gemini API Key 才能使用此功能。\n\n您可以在 [Google AI Studio](https://aistudio.google.com/) 免費獲取 Key。");
                    setShowAiModal(true);
                    return;
                }

                const step = PROCESS_STEPS[currentStep];
                
                setIsAiLoading(true);
                setShowAiModal(true);
                setAiContent(""); 

                let prompt = "";
                if (type === 'explain') {
                setAiTitle(`✨ AI 專家解析：${step.title}`);
                prompt = `你是半導體製程專家。請針對 "${step.title}" 這個步驟提供深入的專業解析。
                請包含：
                1. 物理或化學原理 (例如反應式或能量機制)。
                2. 該步驟在先進製程 (如 7nm, 3nm) 面臨的特殊挑戰。
                3. 常見的缺陷或良率問題 (Yield Killers)。
                請用繁體中文回答，語氣專業但易懂，格式請使用 Markdown (但不要用 code block 包裹純文字)。`;
                } else if (type === 'quiz') {
                setAiTitle(`✨ AI 隨堂測驗：${step.title}`);
                prompt = `你是半導體製程教授。請針對 "${step.title}" 出一道單選題。
                請包含：
                1. 題目 (具挑戰性)。
                2. 四個選項 (A, B, C, D)。
                3. 正確答案。
                4. 簡短解析，說明為什麼選這個答案。
                請用繁體中文回答，格式請使用 Markdown (但不要用 code block 包裹純文字)。`;
                }

                try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`,
                    {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                    }),
                    }
                );

                if (!response.ok) {
                    throw new Error('API Call Failed. 請檢查您的 API Key 是否正確。');
                }

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                setAiContent(text);
                } catch (error) {
                setAiContent(`錯誤：${error.message}\n\n請檢查 API Key 或網路連線。`);
                console.error(error);
                } finally {
                setIsAiLoading(false);
                }
            };

            const renderTextWithBold = (text) => {
                if (!text) return null;
                const parts = text.split(/(\*\*.*?\*\*)/g);
                return parts.map((part, index) => {
                if (part.startsWith('**') && part.endsWith('**')) {
                    return <strong key={index} className="text-blue-900">{part.slice(2, -2)}</strong>;
                }
                return <span key={index}>{part}</span>;
                });
            };

            // Wafer Visualizer
            const WaferVisualizer = () => {
                const stepId = PROCESS_STEPS[currentStep].id;

                const containerStyle = is3D ? {
                    transform: 'perspective(1200px) rotateX(60deg) rotateZ(-45deg) translateZ(0px)',
                    transformStyle: 'preserve-3d'
                } : {
                    transform: 'none'
                };

                const depth = '120px';

                return (
                <div className="relative w-full h-80 md:h-96 bg-slate-800 rounded-xl overflow-hidden shadow-inner border border-slate-600 flex items-end justify-center p-4 md:p-8 transition-all duration-500 group">
                    
                    <button 
                    onClick={() => setIs3D(!is3D)}
                    className="absolute top-4 right-4 z-50 bg-slate-700 hover:bg-slate-600 text-white p-2 rounded-lg shadow-lg border border-slate-500 transition-colors flex items-center gap-2 text-xs font-bold"
                    >
                    {is3D ? <Monitor size={16}/> : <BoxIcon size={16}/>}
                    {is3D ? '2D View' : '3D View'}
                    </button>

                    {/* Labels */}
                    <div className={`absolute top-4 left-4 text-slate-300 text-xs font-mono space-y-1 pointer-events-none select-none z-30 transition-opacity ${is3D ? 'opacity-30' : 'opacity-80'}`}>
                    <div className="flex items-center"><span className="w-3 h-3 bg-gray-500 mr-2 border border-gray-400"></span> 矽基板 (Si)</div>
                    <div className={`flex items-center transition-opacity duration-500 ${animState.hasOxide ? 'opacity-100' : 'opacity-30'}`}><span className="w-3 h-3 bg-blue-300 mr-2 border border-blue-200"></span> 氧化層 (SiO2)</div>
                    <div className={`flex items-center transition-opacity duration-500 ${(animState.hasResist && !animState.resistRemoved) ? 'opacity-100' : 'opacity-30'}`}><span className="w-3 h-3 bg-purple-400 mr-2 border border-purple-300"></span> 光阻 (PR)</div>
                    <div className={`flex items-center transition-opacity duration-500 ${animState.hasMetal ? 'opacity-100' : 'opacity-30'}`}><span className="w-3 h-3 bg-slate-200 mr-2 border border-slate-400"></span> 金屬 (Metal)</div>
                    </div>

                    <div 
                    className="relative w-3/4 max-w-md flex flex-col items-center transition-transform duration-1000 ease-in-out transform-style-3d mb-8"
                    style={containerStyle}
                    >
                        {/* CMP Head */}
                        {stepId === 'cmp' && isAnimating && (
                        <div className="absolute top-[-80px] z-50 w-full flex justify-center transform-style-3d" style={{ transform: 'translateZ(0px)' }}>
                            <Cuboid is3D={is3D} width="140px" height="40px" depth="60px" colorClass="bg-slate-700" sideColorClass="bg-slate-800" className="shadow-xl animate-move-horizontal">
                                <div className="flex flex-col items-center">
                                    <span className="text-cyan-300 text-[10px] font-bold tracking-wider">CMP HEAD</span>
                                    <div className="w-24 h-1 bg-cyan-400 rounded-full mt-1 shadow-[0_0_5px_rgba(34,211,238,0.8)]"></div>
                                </div>
                            </Cuboid>
                        </div>
                        )}

                        {/* Mask */}
                        {stepId === 'lithography' && (
                        <div className="absolute top-[-80px] w-full flex justify-center z-40 transform-style-3d">
                            <Cuboid is3D={is3D} width="33%" height="8px" depth={depth} colorClass="bg-black" sideColorClass="bg-gray-900" className="shadow-2xl animate-fade-in-down border border-gray-700" />
                        </div>
                        )}

                        {/* UV Light */}
                        {stepId === 'lithography' && (
                        <div className="absolute top-[-70px] w-3/4 h-[400px] flex justify-between px-4 opacity-0 animate-flash pointer-events-none z-30 transform-style-3d">
                            <div className={`w-1/3 h-full bg-yellow-300 opacity-20 mix-blend-screen ${is3D ? 'transform rotateX(-60deg) origin-top' : ''}`}></div>
                            <div className={`w-1/3 h-full bg-yellow-300 opacity-20 mix-blend-screen ${is3D ? 'transform rotateX(-60deg) origin-top' : ''}`}></div>
                        </div>
                        )}

                        {/* Doping */}
                        {stepId === 'doping' && isAnimating && (
                        <div className="absolute inset-0 z-50 overflow-hidden pointer-events-none transform-style-3d" style={{ transform: 'translateZ(20px)' }}>
                            {[...Array(24)].map((_, i) => (
                            <div 
                                key={i}
                                className="absolute w-1 h-4 bg-green-400 rounded-full shadow-[0_0_5px_#4ade80]"
                                style={{
                                left: `${Math.random() > 0.5 ? (15 + Math.random() * 20) : (65 + Math.random() * 20)}%`,
                                top: `-${Math.random() * 50}%`,
                                animation: `dopingRain 0.5s linear ${Math.random() * 0.5}s infinite`
                                }}
                            />
                            ))}
                        </div>
                        )}

                        <div className="relative w-full flex flex-col justify-end items-center transform-style-3d">
                        
                        {/* Metal (Corrected position: above Oxide 96 + 32 = 128px) */}
                        {animState.hasMetal && (
                            <div className="w-full flex transform-style-3d absolute bottom-[128px]" style={{ 
                            height: animState.isPolished ? '0px' : '48px', 
                            transition: 'height 3s linear, opacity 3s linear',
                            opacity: animState.isPolished ? 0 : 1
                            }}>
                                <Cuboid is3D={is3D} width="100%" height="100%" depth={depth} colorClass="bg-slate-300" sideColorClass="bg-slate-400" topColorClass="bg-slate-100">
                                <div className="absolute inset-0 bg-gradient-to-br from-transparent via-white/30 to-transparent"></div>
                                </Cuboid>
                            </div>
                        )}

                        {/* Photoresist (Corrected position: above Oxide 96 + 32 = 128px) */}
                        {animState.hasResist && !animState.resistRemoved && (
                            <div className="w-full h-8 flex transform-style-3d absolute bottom-[128px] animate-slide-up">
                            <div className="w-1/3 h-full transform-style-3d">
                                <Cuboid 
                                is3D={is3D}
                                width="100%" height="100%" depth={depth} 
                                colorClass={animState.isExposed && !animState.isEtched ? 'bg-purple-300' : 'bg-purple-400'} 
                                sideColorClass="bg-purple-500"
                                topColorClass="bg-purple-300"
                                style={{ 
                                    opacity: animState.isEtched ? 0 : (animState.isExposed ? 0.8 : 1),
                                    transition: 'opacity 1s' 
                                }}
                                >
                                {stepId === 'lithography' && isAnimating && <div className="absolute inset-0 bg-yellow-200 opacity-50 animate-pulse"></div>}
                                </Cuboid>
                            </div>
                            <div className="w-1/3 h-full transform-style-3d">
                                <Cuboid 
                                is3D={is3D}
                                width="100%" height="100%" depth={depth} 
                                colorClass="bg-purple-400" 
                                sideColorClass="bg-purple-500"
                                topColorClass="bg-purple-300"
                                />
                            </div>
                            <div className="w-1/3 h-full transform-style-3d">
                                <Cuboid 
                                is3D={is3D}
                                width="100%" height="100%" depth={depth} 
                                colorClass={animState.isExposed && !animState.isEtched ? 'bg-purple-300' : 'bg-purple-400'} 
                                sideColorClass="bg-purple-500"
                                topColorClass="bg-purple-300"
                                style={{ 
                                    opacity: animState.isEtched ? 0 : (animState.isExposed ? 0.8 : 1),
                                    transition: 'opacity 1s' 
                                }}
                                >
                                {stepId === 'lithography' && isAnimating && <div className="absolute inset-0 bg-yellow-200 opacity-50 animate-pulse"></div>}
                                </Cuboid>
                            </div>
                            </div>
                        )}

                        {/* Oxide + Plug (Position: above Silicon 96px) */}
                        <div className={`w-full absolute bottom-[96px] flex transform-style-3d transition-all duration-1000 ${animState.hasOxide ? 'h-8' : 'h-0'}`}>
                            <div className="w-1/3 h-full relative transform-style-3d">
                            <Cuboid 
                                is3D={is3D}
                                width="100%" height="100%" depth={depth} 
                                colorClass="bg-blue-300" sideColorClass="bg-blue-400" topColorClass="bg-blue-200"
                                style={{ 
                                transform: animState.isEtched ? 'scaleY(0)' : 'scaleY(1)', 
                                transformOrigin: 'bottom',
                                transition: 'transform 1s'
                                }}
                            />
                            {animState.hasMetal && (
                                <div className="absolute inset-0 transform-style-3d" style={{
                                transform: animState.hasMetal ? 'scaleY(1)' : 'scaleY(0)',
                                transformOrigin: 'bottom',
                                transition: 'transform 1s'
                                }}>
                                <Cuboid is3D={is3D} width="100%" height="100%" depth={depth} colorClass="bg-slate-300" sideColorClass="bg-slate-400" topColorClass="bg-slate-200" />
                                </div>
                            )}
                            </div>
                            <div className="w-1/3 h-full relative transform-style-3d">
                            <Cuboid is3D={is3D} width="100%" height="100%" depth={depth} colorClass="bg-blue-300" sideColorClass="bg-blue-400" topColorClass="bg-blue-200" />
                            </div>
                            <div className="w-1/3 h-full relative transform-style-3d">
                            <Cuboid 
                                is3D={is3D}
                                width="100%" height="100%" depth={depth} 
                                colorClass="bg-blue-300" sideColorClass="bg-blue-400" topColorClass="bg-blue-200"
                                style={{ 
                                transform: animState.isEtched ? 'scaleY(0)' : 'scaleY(1)', 
                                transformOrigin: 'bottom',
                                transition: 'transform 1s'
                                }}
                            />
                            {animState.hasMetal && (
                                <div className="absolute inset-0 transform-style-3d" style={{
                                transform: animState.hasMetal ? 'scaleY(1)' : 'scaleY(0)',
                                transformOrigin: 'bottom',
                                transition: 'transform 1s'
                                }}>
                                <Cuboid is3D={is3D} width="100%" height="100%" depth={depth} colorClass="bg-slate-300" sideColorClass="bg-slate-400" topColorClass="bg-slate-200" />
                                </div>
                            )}
                            </div>
                        </div>

                        {/* Silicon Substrate (Base, height 96px) */}
                        <div className="relative w-full h-24 transform-style-3d z-0">
                            <Cuboid 
                            is3D={is3D}
                            width="100%" 
                            height="100%" 
                            depth={depth} 
                            colorClass="bg-gray-500" 
                            sideColorClass="bg-gray-600" 
                            topColorClass="bg-gray-400"
                            className="shadow-2xl"
                            >
                            <div className={`absolute top-0 left-0 w-1/3 h-12 rounded-br-xl bg-green-500 transition-all duration-1000 blur-sm mix-blend-overlay
                                ${animState.isDoped ? 'opacity-80 translate-y-0' : 'opacity-0 -translate-y-4'}
                            `}></div>
                            <div className={`absolute top-0 right-0 w-1/3 h-12 rounded-bl-xl bg-green-500 transition-all duration-1000 blur-sm mix-blend-overlay
                                ${animState.isDoped ? 'opacity-80 translate-y-0' : 'opacity-0 -translate-y-4'}
                            `}></div>
                            <div className="absolute bottom-2 right-4 text-gray-300 font-bold text-xl opacity-30">Si Substrate</div>
                            </Cuboid>
                        </div>

                        </div>
                    </div>
                </div>
                );
            };

            const AiModal = () => {
                if (!showAiModal) return null;

                return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col border border-slate-200">
                    <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-blue-50 to-white">
                        <h3 className="text-lg font-bold text-blue-800 flex items-center gap-2">
                        <Sparkles size={20} className="text-yellow-500" />
                        {aiTitle}
                        </h3>
                        <button 
                        onClick={() => setShowAiModal(false)}
                        className="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-500"
                        >
                        <X size={20} />
                        </button>
                    </div>

                    <div className="p-6 overflow-y-auto flex-grow bg-slate-50/50">
                        {isAiLoading ? (
                        <div className="flex flex-col items-center justify-center h-48 space-y-4">
                            <Loader2 size={40} className="text-blue-500 animate-spin" />
                            <p className="text-slate-500 text-sm animate-pulse">Gemini AI 正在思考中...</p>
                        </div>
                        ) : (
                        <div className="prose prose-slate max-w-none">
                            {aiContent.split('\n').map((line, idx) => (
                            <p key={idx} className="mb-2 text-slate-700 leading-relaxed">
                                {renderTextWithBold(line)}
                            </p>
                            ))}
                        </div>
                        )}
                    </div>

                    <div className="p-4 border-t border-slate-100 bg-white flex justify-end">
                        <button 
                        onClick={() => setShowAiModal(false)}
                        className="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium transition-colors"
                        >
                        關閉
                        </button>
                    </div>
                    </div>
                </div>
                );
            };

            return (
                <div className="min-h-screen p-4 md:p-8">
                <AiModal />

                <div className="max-w-6xl mx-auto">
                    <header className="mb-8 text-center">
                    <h1 className="text-3xl md:text-4xl font-bold text-slate-900 mb-2 flex justify-center items-center gap-3">
                        <Activity className="text-blue-600" />
                        晶圓製程實驗室
                    </h1>
                    <p className="text-slate-500">互動式半導體製程模擬器 • Powered by Gemini AI</p>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <div className="lg:col-span-2 space-y-6">
                        <WaferVisualizer />

                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <button 
                            onClick={prevStep} 
                            disabled={currentStep === 0}
                            className={`flex items-center px-4 py-2 rounded-lg font-medium transition-colors ${currentStep === 0 ? 'text-slate-300 cursor-not-allowed' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}`}
                        >
                            <ChevronLeft size={20} className="mr-1" /> 上一步
                        </button>

                        <div className="flex flex-col items-center">
                            <span className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Current Step</span>
                            <span className="text-lg font-bold text-blue-600">{currentStep + 1} / {PROCESS_STEPS.length}</span>
                        </div>

                        <div className="flex gap-2">
                            <button 
                            onClick={reset}
                            className="p-2 text-slate-400 hover:text-slate-600 transition-colors"
                            title="重新開始"
                            >
                            <RefreshCcw size={20} />
                            </button>
                            <button 
                            onClick={nextStep} 
                            disabled={currentStep === PROCESS_STEPS.length - 1}
                            className={`flex items-center px-6 py-2 rounded-lg font-bold shadow-md transition-transform active:scale-95 ${currentStep === PROCESS_STEPS.length - 1 ? 'bg-slate-100 text-slate-300 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}`}
                            >
                            {currentStep === PROCESS_STEPS.length - 1 ? '完成' : '下一步'} <ChevronRight size={20} className="ml-1" />
                            </button>
                        </div>
                        </div>
                    </div>

                    <div className="lg:col-span-1">
                        <div className="bg-white h-full p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col">
                        
                        <div className="flex items-center gap-3 mb-4 pb-4 border-b border-slate-100">
                            <div className={`p-3 rounded-full ${PROCESS_STEPS[currentStep].color}`}>
                            {PROCESS_STEPS[currentStep].icon}
                            </div>
                            <h2 className="text-xl font-bold">{PROCESS_STEPS[currentStep].title}</h2>
                        </div>

                        <div className="flex-grow space-y-4">
                            <div>
                            <h3 className="text-sm font-bold text-slate-400 uppercase mb-1">製程說明</h3>
                            <p className="text-slate-700 leading-relaxed">
                                {PROCESS_STEPS[currentStep].description}
                            </p>
                            </div>

                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                            <h3 className="text-xs font-bold text-blue-500 uppercase mb-2">操作指令</h3>
                            <p className="text-blue-800 font-medium text-sm flex items-start">
                                <ChevronRight size={16} className="mt-0.5 mr-1 flex-shrink-0" />
                                {PROCESS_STEPS[currentStep].instruction}
                            </p>
                            </div>

                            {/* AI Integration Section */}
                            <div className="bg-gradient-to-br from-purple-50 to-blue-50 p-4 rounded-lg border border-purple-100 mt-4">
                            <div className="flex justify-between items-start mb-3">
                                <h3 className="text-xs font-bold text-purple-600 uppercase flex items-center gap-1">
                                    <Sparkles size={14} /> Gemini AI 智慧學習
                                </h3>
                                <input 
                                    type="password"
                                    placeholder="貼上 API Key"
                                    value={userApiKey}
                                    onChange={(e) => setUserApiKey(e.target.value)}
                                    className="text-[10px] p-1 border border-purple-200 rounded w-24 focus:w-32 transition-all focus:outline-none focus:border-purple-400 bg-white/80"
                                />
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                                <button 
                                onClick={() => callGemini('explain')}
                                className="flex flex-col items-center justify-center p-3 bg-white border border-purple-200 rounded-lg hover:shadow-md hover:border-purple-400 transition-all group"
                                >
                                    <MessageSquare size={20} className="text-purple-500 mb-1 group-hover:scale-110 transition-transform" />
                                    <span className="text-xs font-bold text-slate-600">深入講解</span>
                                </button>
                                <button 
                                onClick={() => callGemini('quiz')}
                                className="flex flex-col items-center justify-center p-3 bg-white border border-blue-200 rounded-lg hover:shadow-md hover:border-blue-400 transition-all group"
                                >
                                    <HelpCircle size={20} className="text-blue-500 mb-1 group-hover:scale-110 transition-transform" />
                                    <span className="text-xs font-bold text-slate-600">生成測驗</span>
                                </button>
                            </div>
                            </div>

                            <div className="pt-4">
                                <h3 className="text-sm font-bold text-slate-400 uppercase mb-2">工業知識補充</h3>
                                <p className="text-xs text-slate-500 leading-relaxed">
                                    {currentStep === 0 && "現在的晶圓尺寸主要為 12 吋 (300mm)，越大的晶圓可以切割出越多晶片，降低成本。"}
                                    {currentStep === 1 && "常見的沈積技術有 CVD (化學氣相沈積) 和 PVD (物理氣相沈積)。"}
                                    {currentStep === 2 && "光阻的均勻度至關重要，通常使用快速旋轉產生的離心力來塗佈。"}
                                    {currentStep === 3 && "這是最昂貴的步驟。EUV (極紫外光) 機台一台造價數億美金，是用來製造 7nm 以下先進製程的關鍵。"}
                                    {currentStep === 4 && "分為乾式蝕刻(電漿)與濕式蝕刻(化學液)。先進製程多使用各向異性的乾式蝕刻來確保線條垂直度。"}
                                    {currentStep === 5 && "清潔步驟若不徹底，殘留的粒子會導致後續製程失敗，影響良率。"}
                                    {currentStep === 6 && "透過控制摻雜的濃度和深度，我們可以精確控制電晶體的開關特性 (Threshold Voltage)。"}
                                    {currentStep === 7 && "鋁(Aluminum)曾經是主要導線材料，但為了追求更快的速度，現在先進製程多改用電阻更低的銅(Copper)。"}
                                    {currentStep === 8 && "CMP 技術的成熟是半導體進入多層導線時代的關鍵，它能解決堆疊多層後表面凹凸不平的問題。"}
                                </p>
                            </div>
                        </div>

                        <div className="mt-6 pt-4 border-t border-slate-100">
                            <div className="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                            <div 
                                className="bg-blue-600 h-full transition-all duration-500"
                                style={{ width: `${((currentStep + 1) / PROCESS_STEPS.length) * 100}%` }}
                            ></div>
                            </div>
                            <p className="text-center text-xs text-slate-400 mt-2">製程進度</p>
                        </div>

                        </div>
                    </div>

                    </div>
                </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SemiconductorFab />);
    </script>
</body>
</html>
